{% extends "base.html" %}

{% block content %}
<div class="page-header mb-4">
  <h1 class="h2"><i class="bi bi-check-circle"></i> Article Approvals</h1>
  <p class="text-muted">Review and approve pending articles</p>
</div>

<!-- Pending Articles -->
{% if pending_articles %}
<div class="row">
  {% for article in pending_articles %}
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card h-100 border-warning">
      <div class="card-header bg-warning bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{{ article.title }}</h5>
          <span class="badge bg-warning">Pending</span>
        </div>
      </div>
      <div class="card-body">
        {% if article.category %}
        <p class="text-muted small mb-2">
          <i class="bi bi-tag"></i> {{ article.category.name }}
        </p>
        {% endif %}

        <p class="card-text text-muted">
          {{ article.body[:200]|striptags }}{% if article.body|length > 200 %}...{% endif %}
        </p>

        <div class="mb-3">
          <small class="text-muted">
            <i class="bi bi-person"></i> <strong>Author:</strong> {{ article.author.full_name }}<br>
            <i class="bi bi-calendar"></i> <strong>Submitted:</strong> {{ article.updated_at.strftime('%b %d, %Y at %I:%M %p') }}
          </small>
        </div>

        {% if article.tags %}
        <div class="mb-2">
          <small><strong>Tags:</strong></small>
          <div class="d-flex flex-wrap gap-1 mt-1">
            {% for tag in article.tags.split(',')[:3] if tag.strip() %}
            <span class="badge bg-secondary">{{ tag.strip() }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      <div class="card-footer bg-transparent">
        <div class="d-grid gap-2">
          <a href="{{ url_for('kb_articles.view_article', article_id=article.id) }}"
             class="btn btn-sm btn-outline-primary">
            <i class="bi bi-eye"></i> Review Article
          </a>
          <div class="btn-group" role="group">
            <form method="POST" action="{{ url_for('kb_articles.approve_article', article_id=article.id) }}" class="flex-fill">
              <button type="submit" class="btn btn-sm btn-success w-100">
                <i class="bi bi-check-circle"></i> Approve
              </button>
            </form>
            <form method="POST" action="{{ url_for('kb_articles.reject_article', article_id=article.id) }}" class="flex-fill">
              <button type="submit" class="btn btn-sm btn-danger w-100">
                <i class="bi bi-x-circle"></i> Reject
              </button>
            </form>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ article.id }}">
            <i class="bi bi-trash"></i> Delete Article
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-success">
  <i class="bi bi-check-circle-fill"></i> <strong>All caught up!</strong> No articles pending approval.
</div>

<div class="card">
  <div class="card-body text-center py-5">
    <i class="bi bi-inbox" style="font-size: 4rem; color: var(--text-muted);"></i>
    <h4 class="mt-3">No Pending Articles</h4>
    <p class="text-muted">When staff members submit articles for review, they'll appear here.</p>
    <a href="{{ url_for('kb_articles.list_articles') }}" class="btn btn-primary mt-3">
      <i class="bi bi-journal-text"></i> View All Articles
    </a>
  </div>
</div>
{% endif %}

<!-- Quick Stats -->
<div class="row mt-4">
  <div class="col-md-4 mb-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Draft Articles</h6>
            <h3 class="mb-0">{{ draft_count }}</h3>
          </div>
          <i class="bi bi-file-earmark" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Pending Review</h6>
            <h3 class="mb-0">{{ pending_count }}</h3>
          </div>
          <i class="bi bi-clock-history" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Published Articles</h6>
            <h3 class="mb-0">{{ published_count }}</h3>
          </div>
          <i class="bi bi-check-circle-fill" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modals -->
{% if pending_articles %}
{% for article in pending_articles %}
<div class="modal fade" id="deleteModal{{ article.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ article.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel{{ article.id }}">
          <i class="bi bi-exclamation-triangle"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Are you sure you want to delete this article?</p>
        <div class="alert alert-warning mb-0">
          <strong>Warning:</strong> This action cannot be undone. The article "{{ article.title }}" will be permanently deleted.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('kb_articles.api_delete_article', article_id=article.id) }}" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Article
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endif %}

{% endblock %}
